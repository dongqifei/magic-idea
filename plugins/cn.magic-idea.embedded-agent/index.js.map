{"version":3,"file":"index.js","sources":["../../../plugins/cn.magic-idea.embedded-agent/src/index.ts"],"sourcesContent":["import { inject, injectable, ContainerModule, postConstruct } from \"@capital/shared/inversify\";\r\nimport { regContainerModule } from '@capital/core/plugin';\r\nimport { ApplicationShellLayout } from '@capital/core/shell';\r\nimport { CommandContribution } from '@capital/core/commands';\r\nimport { getLogger } from '@capital/core/logger';\r\nimport { Widget } from \"@capital/core/widgets\";\r\nimport { PreferenceContribution, PreferenceService } from '@capital/core/preferences';\r\nimport { PreferenceSchema } from \"@capital/core/preferences\";\r\n\r\nexport const EmbeddedAgentPreferencesSchema: PreferenceSchema = {\r\n  \"title\": \"内嵌智能体\",\r\n  \"properties\": {\r\n    \"extensions.embedded-agent.agentUrl\": {\r\n      \"type\": \"string\",\r\n      \"default\": \"https://yuanqi.tencent.com/agent/m5fSqCnzYVca\",\r\n      \"title\": \"智能体地址\",\r\n      \"description\": \"第三方智能体平台发布的服务地址\"\r\n    }\r\n  }\r\n};\r\n\r\nexport const EMBEDDED_AGENT_URL_KEY = \"extensions.embedded-agent.agentUrl\";\r\n\r\n@injectable()\r\nclass EmbeddedAgentWidget extends Widget implements CommandContribution {\r\n\r\n  private logger = getLogger('TencentYuanQiPlugin');\r\n\r\n  constructor(\r\n    @inject(ApplicationShellLayout) private shellLayout: any,\r\n    @inject(PreferenceService) private preferenceService: PreferenceService,\r\n  ) {\r\n    super();\r\n    this.title.label = '智能体';\r\n    this.node.className = 'tencent-yuanqi-view';\r\n    this.node.tabIndex = -1;\r\n    this.node.innerHTML = `<iframe src=\"\" style=\"height: 100%; border: 0; width: 100%; border-radius: 8px;\"/>`;\r\n\r\n    // 注册活动面板\r\n    this.registerPanel();\r\n  }\r\n\r\n  @postConstruct()\r\n  init(): void {\r\n    // 初始化逻辑\r\n    this.preferenceService.ready.then(() => { \r\n      const uri = this.preferenceService.get<string>(EMBEDDED_AGENT_URL_KEY);\r\n      this.refreshEmbeddedAgent(uri);\r\n    });\r\n    // 监听配置文件修改\r\n    this.preferenceService.onDidPreferenceChanged((e) => {\r\n      if (e.key === EMBEDDED_AGENT_URL_KEY && e.newValue) {\r\n        this.refreshEmbeddedAgent(e.newValue);\r\n      }\r\n    });\r\n  }\r\n\r\n  registerPanel() {\r\n    const activityManager = this.shellLayout.activityManager;\r\n    activityManager.registerActivity({\r\n      id: 'embedded-agent',\r\n      title: '智能助手',\r\n      iconClass: 'codicon codicon-agent',\r\n      priority: 30,\r\n      location: 'right-top',\r\n      toolbarConfig: {\r\n        items: [\r\n          {\r\n            id: 'embedded-agent-refresh',\r\n            type: 'button',\r\n            commandId: 'plugin.embedded-agent.action.refresh'\r\n          }\r\n        ]\r\n      },\r\n      factory: () => {\r\n        return this;\r\n      }\r\n    });\r\n  }\r\n\r\n  registerCommands(registry: CommandRegistry): void {\r\n    registry.addCommand(\"plugin.embedded-agent.action.refresh\", {\r\n      label: \"重新进入智能体\",\r\n      iconClass: 'codicon codicon-refresh',\r\n      execute: () => {\r\n        this.refreshEmbeddedAgent();\r\n      }\r\n    });\r\n  }\r\n\r\n  private refreshEmbeddedAgent(src?: string) {\r\n    const iframe = this.node.querySelector('iframe');\r\n    if (iframe) {\r\n      const originalSrc = src || iframe.src;\r\n      iframe.src = 'about:blank';\r\n      setTimeout(() => {\r\n        iframe.src = originalSrc;\r\n      }, 0);\r\n      this.logger.debug(\"重新进入智能体\");\r\n    }\r\n  }\r\n}\r\n\r\nconst EmbeddedAgentModule = new ContainerModule(\r\n  (bind: any) => {\r\n  bind(EmbeddedAgentWidget).toSelf().inSingletonScope();\r\n\r\n  bind(CommandContribution).toService(EmbeddedAgentWidget);\r\n  bind(PreferenceContribution).toConstantValue({ schema: EmbeddedAgentPreferencesSchema });\r\n})\r\n// 注册容器模块到插件中心\r\nregContainerModule(EmbeddedAgentModule);"],"names":["Widget","getLogger","postConstruct","injectable","inject","ApplicationShellLayout","PreferenceService","ContainerModule","CommandContribution","PreferenceContribution","regContainerModule"],"mappings":"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"}