import{K as g,Q as _,Y as f,T as v,W as y,f as R,e as S,F as C}from"./index-Oj7xzQpQ.js";var d=(t=>(t.ERROR="error",t.DEFAULT="monaco-editor",t.DIFFE_EDITOR="monaco-diff-editor",t))(d||{});const O=Symbol("EditorStrategy");var E=Object.getOwnPropertyDescriptor,w=(t,e,s,i)=>{for(var o=i>1?void 0:i?E(e,s):e,c=t.length-1,a;c>=0;c--)(a=t[c])&&(o=a(o)||o);return o},h=(t,e)=>(s,i)=>e(s,i,t);const D=Symbol("EditorProvider");let u=class{constructor(t,e){this.themeService=e,t.forEach(s=>this.registerProvider(s,100))}providers=[];registerProvider(t,e=0){const s=this.providers.findIndex(i=>i.provider.id===t.id);if(s!==-1){this.providers[s]={provider:t,priority:e};return}this.providers.push({provider:t,priority:e})}unregisterProvider(t){this.providers=this.providers.filter(e=>e.provider.id!==t)}async createWidget(t,e){const s=e;if(s.editorId){const r=this.providers.find(m=>m.provider.id===s.editorId);if(!r)throw new Error(`Editor provider '${s.editorId}' not registered`);const n=await r.provider.createEditor(t,s);return this._wireLifecycle(t,n,r.provider),n}const i=this.providers.map(r=>{const n=r.provider.score?r.provider.score(t,s):r.priority;return{entry:r,score:n??0}}).filter(r=>r.score>0);if(i.length===0)throw new Error(`No editor provider available for ${t}`);i.sort((r,n)=>n.score-r.score);const o=i[0].entry.provider,c=o.createEditor(t,s),a=c instanceof Promise?await c:c;return this._wireLifecycle(t,a,o),a}_wireLifecycle(t,e,s){e.disposed.connect(()=>{s.dispose&&s.dispose(t)})}};u=w([g(),h(0,_(D)),h(1,f(v))],u);class l extends y{resourceUri;options;_ref;_editor;_model;_shouldFocusOnActivate=!1;_isConflict=!1;_loadingElement;static DIRTY_CLASS="magic-mod-dirty";constructor(e,s,i,o){super(),this.addClass("editor-widget"),this.resourceUri=e,this._editor=i,this._model=o??null,this.options=s;const c=s.name;this.node.dataset.resourceUri=e.toString(),this.node.dataset.resourcePath=c,this.node.__monacoEditor=i,this.node.__monacoModel=o,this.id=`editor-${Math.random().toString(36).slice(2,9)}-${Date.now()}`,this.title.label=this.getTitleLabel(c),this.title.closable=!0,this.title.className="magic-editor-title";const a=R.getClassWithColor(e.path);this.title.iconClass="file-icon "+a,this.title.dataset={resourceUri:e.toString(),language:s.language||""},this.setDirty(s.isDirty);const r=document.createElement("div");r.className="magic-progress-container progress-ten",r.style.width="100%",r.style.zIndex="6",r.style.top="0",r.style.display="none",this._loadingElement=r,this.node.appendChild(r)}hideLoading(){this._loadingElement.style.display="none"}showLoading(){this._loadingElement.style.display="block"}setShouldFocusOnActivate(e){this._shouldFocusOnActivate=e}setFileName(e){this.title.label=e,this.options.fileName=e}setDirty(e){this.options.isDirty=e??!1;const s=` ${l.DIRTY_CLASS}`;this.title.className=this.title.className.replace(s,""),e&&(this.title.className+=s)}getTitleLabel(e){return(!e||e==="")&&(e=this.resourceUri.fileName),this.getLabelPrefix()+e}get ref(){return this._ref}set ref(e){this._ref=e}get editor(){return this._editor}get model(){return this._model}get editorType(){return d.DEFAULT}onAfterAttach(e){this.doLayout()}onResize(e){this.doLayout()}onUpdateRequest(e){this.doLayout()}onActivateRequest(e){this.isAttached&&this._shouldFocusOnActivate&&this.focus()}onBeforeDetach(e){}dispose(){try{this.disposeEditor()}catch{}super.dispose()}}class P extends l{constructor(e,s){super(e,s,null,null),this.title.caption="已删除",this.title.className=super.title.className+" deleted",this.node.innerHTML=`<div class="resource-empty"><span class='codicon codicon-error error'></span><p>编辑器打开失败。</p></div>`}get editorType(){return d.ERROR}getLabelPrefix(){return""}getValue(){return""}focus(){}disposeEditor(){}doLayout(){}}var T=Object.getOwnPropertyDescriptor,L=(t,e,s,i)=>{for(var o=i>1?void 0:i?T(e,s):e,c=t.length-1,a;c>=0;c--)(a=t[c])&&(o=a(o)||o);return o},M=(t,e)=>(s,i)=>e(s,i,t);let p=class{constructor(t){this.fileSystemService=t,this.cacheTTL=0,this.cacheSize=50}modelRegistry=new Map;modelDisposables=new Map;refCount=new Map;lruQueue=[];cacheTimers=new Map;cacheTTL;cacheSize;getModel(t){const e=this.modelRegistry.get(this._parseResourceUri(t));return e&&!e.isDisposed()?e:void 0}createOrGetModel(t,e){const s=this._parseResourceUri(t);let i=this.modelRegistry.get(s);if(i&&!i.isDisposed())return i;i=S.createModel("",e?.language,t.uri),this.fileSystemService.readFile(t).then(a=>{i?.setValue(a?.script||e?.script||"")}),this.modelRegistry.set(s,i);const o=i.onDidChangeContent(()=>{this._onModelContentChanged(t)}),c=i.onWillDispose(()=>{try{o.dispose()}catch{}this._cleanupModel(t)});return this.modelDisposables.set(s,c),i}pinModel(t,e){const s=this._parseResourceUri(t),i=this.modelRegistry.get(s)||this.createOrGetModel(t,e),o=this.refCount.get(s)??0;return this.refCount.set(s,o+1),this._cancelEviction(s),this._touchLRU(t),i}releaseModel(t){const e=this._parseResourceUri(t),s=this.refCount.get(e)??0,i=Math.max(0,s-1);i===0?(this.refCount.delete(e),this._scheduleEviction(t)):this.refCount.set(e,i),this._touchLRU(t)}disposeModel(t){const e=this._parseResourceUri(t),s=this.modelRegistry.get(e);if(s&&!s.isDisposed())try{this.fileSystemService.cleanupState(t),s.dispose()}catch(i){console.error(i)}}async _onModelContentChanged(t){const e=this.modelRegistry.get(this._parseResourceUri(t));if(!e||e.isDisposed())return;const s=e.getValue();this.fileSystemService.updateFileData(t,{script:s})}_scheduleEviction(t){const e=this._parseResourceUri(t);if(this.refCount.get(e))return;if(this.cacheTTL<=0){this.disposeModel(t);return}this._touchLRU(t);const s=window.setTimeout(()=>{this.refCount.get(e)||(this._ensureCacheSize(),this.refCount.get(e)||this.disposeModel(t)),this.cacheTimers.delete(e)},this.cacheTTL);this.cacheTimers.set(e,s)}_cancelEviction(t){const e=this.cacheTimers.get(t);e!==void 0&&(clearTimeout(e),this.cacheTimers.delete(t))}_touchLRU(t){const e=this.lruQueue.indexOf(t);e!==-1&&this.lruQueue.splice(e,1),this.lruQueue.unshift(t),this._ensureCacheSize()}_ensureCacheSize(){for(;this.lruQueue.length>this.cacheSize;){const t=this.lruQueue.pop();if(!t)break;const e=this._parseResourceUri(t);this.refCount.get(e)||this.disposeModel(t)}}_cleanupModel(t){const e=this._parseResourceUri(t);try{this.modelRegistry.delete(e);const s=this.modelDisposables.get(e);if(s)try{s.dispose?.()}catch{}this.modelDisposables.delete(e),this.refCount.delete(e);const i=this.lruQueue.indexOf(t);i!==-1&&this.lruQueue.splice(i,1);const o=this.cacheTimers.get(e);o!==void 0&&(clearTimeout(o),this.cacheTimers.delete(e))}catch{}}_parseResourceUri(t){try{return t.resourceId}catch{throw new Error(`Invalid resource URI: ${t.toString()}`)}}};p=L([g(),M(0,f(C))],p);export{p as D,d as E,O as a,l as b,P as c,u as d,D as e};
